# Some Notes on the "Limitations" of Native Image

Native Image is a new way to build Java applications.  It depends on a certain set of assumptions and it is these 
assumptions that in turn lead to the benefits that Native Image brings (fast startup, low memory etc.).

With these assumputions & benefits there do also come some limitations, although it is worth stressing that there are 
work arounds for many of these limitations.

Let's take a look at some of these limitations.

<div class="inline-container">
<img src="../images/noun_Book_3652476_100.png">
<strong>References:</strong>
</div>

- [Native Image : Native Image Compatibility and Optimization Guide](https://www.graalvm.org/reference-manual/native-image/Limitations/)

- [Native Image : JCA Security Services in Native Image](https://www.graalvm.org/reference-manual/native-image/JCASecurityServices/)

## Limitations

- Dynmic class loading is not supported at runtime
    - But we can tell the native image tool about classes that we want to load at build time
- Reflection is not supported at runtime
	- "Reflection can be used without restrictions during a native image generation, for example, in class initializers."
    - We can tell the natve image build tool about any reflection that will happen at runtime and it can thus be supported, as long as we inform the built tool about it
- Dynamic Proxies
    - We can inform the build tool about the use of Dynamic Proxies and they can thus be used, but the byte-code must be generated ahead-of-time.
- JCA
	- `--enable-all-security-services`
	- Enabled by default when you enable `https`
- JNI
- Use the agentlib to generate this config. More on this later

## Unsupported Features of Java / JVM

- Invokedynamic & Method Handles
	- "Note that invokedynamic use cases generated by javac for, e.g., Java lambda expressions and string concatenation are supported because they do not change called methods at image run time"
- Serialisation
	- Could be supported, but as serialisation is a source of security issues and will the mechanism will be replaced this isn't currently supported
		- This effects any libraries etc that rely on serialisation, such as **RMI**
- Security Manager

## Things that Behave Differently in Native Image

### Signal Handlers

- You don't need them in a shared lib, so Native Image gives you the choice

- If you are running inside a container environment, you want shutdown hooks to be installed
	- `--install-exit-handlers`

### Class Initializers

- All of your apps classes will be inititalised at runtime. Default behaviour

- But be aware you have the power to initialise them at build time. More on this later

### Finalizers

- These are not invoked in a native image

- They are deprecated since JDK 9

- They are dangerous :)	

### Unsafe Memory Access

- Fields accessed from `sun.misc.Unsafe`

- If, and only if, they are stored ina `static final` field the memory location will be recomputed when the image is generated

- If used in other ways, you need to make use of the `RecomputeFieldValue` annotation

## OK, but can you do anything?

- You can do a lot!